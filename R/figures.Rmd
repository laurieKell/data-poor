---
title: "Data poor validation" 
subtitle: "Myers data"
author: "Laurence Kell"
output: rmarkdown:::pdf_document
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
tags: FLPKG FLR
license: Creative Commons Attribution-ShareAlike 4.0 International
---
  
```{r knitr_init, echo=FALSE, results="hide"}
library(knitr)
## Global options
opts_chunk$set(echo    =FALSE,
               eval    =TRUE,
               cache   =TRUE,
               cache.path="../cache/myers/",
               prompt  =FALSE,
               comment =NA,
               message =FALSE,
               tidy    =FALSE,
               warning =FALSE,
               fig.height=6,
               fig.width =6,
               fig.path  ="../tex/myers-",
               dev       ="png")

options(digits=3)

iFig=0
```

```{r, pkgs, echo=FALSE, message=FALSE}
library(reshape)
library(plyr)
library(dplyr)
library(GGally)
```

```{r, data, fig.height=6, fig.width=6}
dirMy="/home/laurence-kell/Desktop/papers/data-poor"

load(file.path(dirMy,"data/myers.RData"))
load(file.path(dirMy,"results/myersRuns.RData"))

bbmsy=subset(runs,variable=="b_div_bmsy")
bbmsy=cast(bbmsy,assessid+year~run,value="mean")

bbmsy=merge(bbmsy,myers,by=c("assessid","year"))
```


```{r, trend}
trnd=bbmsy[,c("biomass","bd","bd4","sra")]

my_lower<-function(data,mapping,...){
  ggplot(data=data,mapping=mapping)+
    #geom_smooth(method="lm",se=FALSE,fullrange=TRUE)+
    geom_point(...)+
    scale_shape_manual(values=c(0,1))}

my_density<-function(data,mapping,...){
  ggplot(data=data,mapping=mapping)+
    geom_density(...,lwd=1)}

ggpairs(log(trnd),columns=1:4,
           #mapping=aes(color=smoke,shape=sex,lty=sex),
           columnLabels=c("True\nAbundance","Biomass\nDynamic","BD with 40% CV","SRA"),
           lower=list(continuous=wrap(my_lower,alpha=0.25,col="black",fill="red")),
           diag=list(continuous=wrap(my_density,alpha=0.5)),
           upper=list(continuous=wrap("cor",size=4)))+
          theme_bw()
```

**Figure `r iFig=iFig+1; iFig`** Comparison of time series. 

```{r, regression}
trend<-function(x,n=10){
    
    if (length(x)<n) return(NA)
    
    y=x[length(x)-(n:1)+1]
    
    if (any(is.na(x))) return(NA)
    
    lm(y~x,data=data.frame(x=seq(n),y=y))$coef[2]}

trd=ddply(bbmsy, .(assessid), with, data.frame(
                                         biomass=trend(biomass),
                                         bd     =trend(bd),
                                         bd4    =trend(bd4),
                                         sra    =trend(sra)))

ggpairs(trd[,-1],
           columnLabels=c("True\nAbundance","Biomass\nDynamic","BD with 40% CV","SRA"),
           lower=list(continuous=wrap(my_lower,alpha=0.25,col="black",fill="red")),
           diag=list(continuous=wrap(my_density,alpha=0.5)),
           upper=list(continuous=wrap("cor",size=4)))+
          theme_bw()
```

**Figure `r iFig=iFig+1; iFig`** Comparison of trends in last 10 years. 


```{r, trend-5}
fnl=ddply(bbmsy, .(assessid), function(x) x[x$year>=max(x$year)-4,])

ggpairs(log(fnl[,c("biomass","bd","bd4","sra")]),
           columnLabels=c("True\nAbundance","Biomass\nDynamic","BD with 40% CV","SRA"),
           lower=list(continuous=wrap(my_lower,alpha=0.25,col="black",fill="red")),
           diag=list(continuous=wrap(my_density,alpha=0.5)),
           upper=list(continuous=wrap("cor",size=4)))+
          theme_bw()
```

**Figure `r iFig=iFig+1; iFig`** Comparison of trends in last 5 years. 


```{r, 2o3}
twothree<-function(x,n1=2,n2=3){
  
  if (length(x)<n1+n2) return(NULL)
  
  mean(x[length(x)-seq(n1)+1])/mean(x[length(x)-(n1+n2):n2+1])}

t23=ddply(bbmsy, .(assessid), with, data.frame(
                                          biomass=twothree(biomass),
                                          bd     =twothree(bd),
                                          bd4    =twothree(bd4),
                                          sra    =twothree(sra)))


ggpairs(t23[,-1],
           columnLabels=c("True\nAbundance","Biomass\nDynamic","BD with 40% CV","SRA"),
           lower=list(continuous=wrap(my_lower,alpha=0.25,col="black",fill="red")),
           diag=list(continuous=wrap(my_density,alpha=0.5)),
           upper=list(continuous=wrap("cor",size=4)))+
          theme_bw()
```

**Figure `r iFig=iFig+1; iFig`** Comparison of 2 over 3, i.e. mean of last 2 years divided by mean in years -5 to -3. 


```{r, dplt-final}
fnl=ddply(bbmsy, .(assessid), function(x) x[x$year>=max(x$year)-4,])

ggpairs(log(fnl[,c("biomass","bd","bd4","sra")]),
           columnLabels=c("True\nAbundance","Biomass\nDynamic","BD with 40% CV","SRA"),
           lower=list(continuous=wrap(my_lower,alpha=0.25,col="black",fill="red")),
           diag=list(continuous=wrap(my_density,alpha=0.5)),
           upper=list(continuous=wrap("cor",size=4)))+
          theme_bw()
```

**Figure `r iFig=iFig+1; iFig`** Comparison of depeletion estimates in final year. 


```{r, cv}
cvFn=function(x) (var(x,na.rm=TRUE)^1/2)/mean(x,na.rm=TRUE)
```


```{r}
chk=ddply(fnl[,c(1,4:5)],.(assessid),with,data.frame(flag=!is.na(bd4)&!is.na(sra)))

cat=transmute(fnl,catsra  =paste("OM=",biomass>1," MP=",sra>1,sep=""),
                  catbd   =paste("OM=",biomass>1," MP=",bd4>1,sep=""),
                  assessid=assessid)
bb =merge(bbmsy,cat)
bb =subset(bb,assessid%in%subset(chk,flag)[,1])
bb =ddply(bb,.(assessid), transform, catch=catch/mean(catch))


bb =melt(bb[,c("assessid","year","sra","bd4","biomass","catch","catsra","catbd")],id=c("assessid","year","catsra","catbd"))

bb$catsra=factor(bb$catsra,levels=c("OM=TRUE MP=TRUE", "OM=FALSE MP=FALSE",
                                    "OM=TRUE MP=FALSE","OM=FALSE MP=TRUE"))
bb$catbd =factor(bb$catbd, levels=c("OM=TRUE MP=TRUE", "OM=FALSE MP=FALSE",
                                    "OM=TRUE MP=FALSE","OM=FALSE MP=TRUE"))

dat=subset(bb,catbd=="OM=TRUE MP=TRUE")
dat=subset(dat,assessid%in%sample(unique(dat$assessid),10))

ggplot(dat)+
  geom_line(aes(year,value,group=assessid,col=catsra))+
  facet_grid(variable~.,scale="free")+
  theme(legend.position="bottom")
```

**Figure `r iFig=iFig+1; iFig`** BD T*T


```{r}
dat=subset(bb,catbd=="OM=FALSE MP=FALSE")
dat=subset(dat,assessid%in%sample(unique(dat$assessid),10))

ggplot(dat)+
  geom_line(aes(year,value,group=assessid,col=catsra))+
  facet_grid(variable~.,scale="free")+
  theme(legend.position="bottom")
```

**Figure `r iFig=iFig+1; iFig`** BD F*F


```{r}
dat=subset(bb,catbd=="OM=TRUE MP=FALSE")
dat=subset(dat,assessid%in%sample(unique(dat$assessid),10))

ggplot(dat)+   
  geom_line(aes(year,value,group=assessid,col=catsra))+
  facet_grid(variable~.,scale="free")+
  theme(legend.position="bottom")
```

**Figure `r iFig=iFig+1; iFig`** BD T*F


```{r}
dat=subset(bb,catbd=="OM=FALSE MP=TRUE")
dat=subset(dat,assessid%in%sample(unique(dat$assessid),10))

ggplot(dat)+ 
  geom_line(aes(year,value,group=assessid,col=catsra))+
  facet_grid(variable~.,scale="free")+
  theme(legend.position="bottom")
```

**Figure `r iFig=iFig+1; iFig`** BD F*T
